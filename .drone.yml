pipeline:
  notify:
    image: drillster/drone-email
    host: smtp.gmail.com
    username: $${MAILLOGIN}
    password: $${MAILPASS}
    from: buildserwer@droneio
    recipients: [ $${RECIPENT1} ]
    subject: drone build failed
    body: Building repository repo.name failed
    when:
      status: [ failure ]

  restore-cache:
    image: drillster/drone-volume-cache
    restore: true
    mount:
      - ./migration_tool
    volumes:
      - /tmp/cache:/cache

  build:
    image: frekele/ant
    secrets: [ sfusername, sfpass ]
    commands:
      - /bin/sh get_migration_tool_file.sh
      - ant -lib migration_tool/ant-salesforce.jar -Dusername=$${SFUSERNAME} -Dpassword=$${SFPASS}

  rebuild-cache:
    image: drillster/drone-volume-cache
    rebuild: true
    mount:
      - ./migration_tool
    volumes:
      - /tmp/cache:/cache

  auto-tests:
    image: nightwatch2
    secrets: [ dashusername, dashpass ]
    commands:      
      - export DASH_LOGIN=$${DASHUSERNAME}
      - export DASH_PASS=$${DASHPASS}
      - nightwatch tests

services:
  selenium:
    image: selenium/standalone-chrome